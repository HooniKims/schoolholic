# 로그인 기능 구현 (Schoolholic 기준 분석 + 재사용 가이드)

## 1) 문서 목적
- 이 문서는 현재 프로젝트(`schoolholic`)에서 실제로 동작 중인 로그인/인증 구조를 코드 기준으로 정리한 문서다.
- 또한 다른 프로젝트에서도 같은 방식으로 재현할 수 있도록, 구현 순서를 체크리스트 형태로 제공한다.
- 마지막으로 Firebase에서 **관리자(admin) 권한 계정 생성** 절차를 별도로 상세 정리한다.

---

## 2) 현재 프로젝트 인증 구조 요약

### 기술 스택
- `Firebase Authentication`
  - 이메일/비밀번호 로그인
  - Google 소셜 로그인
- `Firestore`
  - 사용자 프로필/권한(role) 저장
  - 로그인 실패 횟수 및 계정 잠금 상태 저장
- `Next.js App Router + React Context`
  - `AuthProvider`로 전역 인증 상태 관리
  - `AuthGuard`로 페이지 접근 제어

### 핵심 파일
- `lib/firebase.ts`
  - Firebase 앱, Auth, Firestore, Google Provider 초기화
- `lib/auth-firebase.ts`
  - 회원가입/로그인/비밀번호 변경/잠금해제/프로필 조회 등 인증 서비스 핵심
- `components/AuthContext.tsx`
  - `onAuthStateChanged` 기반으로 `user/profile/loading` 전역 상태 유지
- `components/AuthGuard.tsx`
  - 미인증 사용자 `/login` 리다이렉트
  - `allowedRoles` 기반 역할 제한
- `app/login/page.tsx`, `app/signup/page.tsx`, `app/admin/page.tsx`
  - 로그인, 회원가입, 관리자 페이지 UI 및 호출 흐름

---

## 3) 데이터 모델 (Firestore `users` 컬렉션)

현재 프로젝트의 `users/{uid}` 문서는 아래 구조를 사용한다.

```ts
{
  uid: string;
  email: string;
  role: 'teacher' | 'parent' | 'admin';
  name: string;
  schoolName: string;
  schoolCode: string;
  grade: number;
  classNum: number;

  // 계정 보호
  isLocked: boolean;            // 기본 false
  failedLoginAttempts: number; // 기본 0

  // parent 전용
  studentName?: string;
  matchedTeacherId?: string | null;

  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

포인트:
- 인증(Auth) 정보와 역할(role)은 분리되어 있음.
  - Auth: 계정 존재/비밀번호/소셜 연동
  - Firestore: 역할/학교정보/잠금상태 등 비즈니스 프로필
- 로그인 성공 시 `failedLoginAttempts`를 0으로 초기화한다.
- 비밀번호 실패 누적 10회 이상이면 `isLocked = true`.

---

## 4) 실제 동작 플로우 (현재 코드 기준)

### A. 이메일 회원가입
1. `createUserWithEmailAndPassword`로 Auth 계정 생성
2. `createUserProfile(uid, data)`로 Firestore 프로필 생성
3. 완료 후 홈(`/`) 이동

### B. Google 회원가입/로그인
1. `signInWithPopup` 실행
2. 기존 프로필(`users/{uid}`) 존재 여부 확인
3. 프로필 있으면 로그인 완료
4. 프로필 없으면 `/signup?google=true...`로 이동 후 추가 정보 입력 후 프로필 생성

### C. 이메일 로그인
1. 이메일로 프로필 조회 (`getUserProfileByEmail`)
2. `isLocked`면 즉시 `ACCOUNT_LOCKED` 에러
3. `signInWithEmailAndPassword` 시도
4. 성공 시 실패 횟수 0으로 리셋
5. 프로필 미존재 시 `PROFILE_NOT_FOUND`
6. 비밀번호 실패 시 실패 횟수 +1, 10회 이상 잠금

### D. 인증 상태 전역 관리
1. `AuthProvider`에서 `onAuthStateChanged` 구독
2. 로그인된 `firebaseUser`가 있으면 Firestore 프로필 로드
3. 전역으로 `user/profile/loading/logout/refreshProfile` 제공

### E. 접근 제어
- `AuthGuard` 사용 페이지
  - `/change-password` (로그인 필요)
  - `/admin` (로그인 + `role === 'admin'`)
- 일부 페이지는 `useEffect`에서 `user` 미존재 시 `/login` 리다이렉트 방식으로 보호

---

## 5) 다른 프로젝트에 옮겨서 구현하는 표준 절차 (성공 패턴)

아래 순서대로 구현하면 안정적으로 재현 가능하다.

### Step 1. Firebase 프로젝트 준비
- Authentication 활성화
  - Sign-in method: `Email/Password`, `Google`
- Firestore 생성
- 웹 앱 등록 후 SDK 키 확인

### Step 2. 환경변수 설정
`.env.local`:

```bash
NEXT_PUBLIC_FIREBASE_API_KEY=...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=...
NEXT_PUBLIC_FIREBASE_PROJECT_ID=...
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=...
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=...
NEXT_PUBLIC_FIREBASE_APP_ID=...
```

### Step 3. Firebase 초기화 모듈 작성
- `lib/firebase.ts`에서 `initializeApp`, `getAuth`, `getFirestore` 초기화
- Google 로그인은 `new GoogleAuthProvider()`와 `prompt: 'select_account'` 권장

### Step 4. 인증 서비스 레이어 분리
- `lib/auth-firebase.ts`에 기능을 묶는다.
  - `signUpWithEmail`
  - `createUserProfile`
  - `signInWithEmail`
  - `signInWithGoogle`
  - `resetPassword`
  - `changePassword`
  - `getUserProfile`
  - `incrementFailedAttempts`, `unlockAccount`, `getLockedAccounts`

### Step 5. 전역 Auth Context 구성
- `onAuthStateChanged`로 세션 감지
- 세션 생기면 Firestore 프로필 조회
- `loading` 상태를 반드시 노출해 초기 렌더 깜빡임 방지

### Step 6. AuthGuard 적용
- 로그인 필요 페이지: `<AuthGuard>`
- 권한 제한 페이지: `<AuthGuard allowedRoles={['admin']}>`

### Step 7. 회원가입 2단계 구조 유지
- Auth 계정 생성과 프로필 입력을 분리하면(특히 Google) UX/확장성이 좋다.
- 소셜 로그인 신규 유저는 추가 프로필 폼으로 유도하는 흐름을 재사용한다.

### Step 8. 계정 보호 기능 포함
- 로그인 실패 누적 카운트 필수
- 임계치(예: 10회) 도달 시 `isLocked` 처리
- 관리자 페이지에서 잠금 해제 제공

### Step 9. Firestore 보안 규칙까지 완료
- UI 가드만으로는 부족하다.
- Firestore Rules에서 `request.auth.uid` + 역할(role) 기반 제어를 반드시 구현한다.

---

## 6) Firebase 관리자 권한 생성 방법 (중요)

현재 프로젝트는 **Firestore `users` 문서의 `role` 필드**로 관리자 권한을 판별한다.

### 방법 A: 콘솔에서 빠르게 관리자 만들기 (현재 프로젝트와 100% 호환)

1. 관리자 계정 후보 사용자를 먼저 회원가입/로그인시킨다.
2. Firebase Console > Authentication > Users에서 해당 사용자의 `UID` 확인
3. Firebase Console > Firestore Database > `users` 컬렉션 > 해당 `UID` 문서 열기
4. 아래 값 확인/수정
   - `role: "admin"`
   - `isLocked: false`
   - `failedLoginAttempts: 0`
5. 앱에서 다시 로그인
6. 홈에서 관리자 아이콘(Shield) 노출 및 `/admin` 접근 가능 여부 확인

주의:
- Auth 사용자만 있고 Firestore 프로필이 없으면 `PROFILE_NOT_FOUND`가 발생한다.
- `users/{uid}` 문서가 반드시 존재해야 한다.

### 방법 B: 운영 환경 강화 방식 (권장)

Firestore role만 쓰지 말고, 필요하면 **Custom Claims**를 추가해 이중 검증한다.

예시(별도 Node 관리 스크립트에서 실행):

```ts
import admin from 'firebase-admin';

admin.initializeApp({
  credential: admin.credential.applicationDefault(),
});

const uid = '관리자_UID';
await admin.auth().setCustomUserClaims(uid, { admin: true });
```

그리고 앱/서버에서:
- ID 토큰의 `admin` claim 확인
- Firestore의 `role === 'admin'`도 함께 확인

실무 권장:
- 빠른 시작: 방법 A
- 운영 보안 강화: 방법 A + 방법 B 병행

---

## 7) Firestore Rules 예시 (역할 기반 최소 템플릿)

현재 저장소에 `firestore.rules` 파일은 없으므로, 콘솔에 직접 적용하거나 파일을 추가해 배포해야 한다.

```js
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isMe(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function myRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && myRole() == 'admin';
    }

    match /users/{uid} {
      allow read: if isMe(uid) || isAdmin();
      allow create: if isMe(uid);
      allow update: if isMe(uid) || isAdmin();
      allow delete: if isAdmin();
    }
  }
}
```

포인트:
- 관리자 기능(`unlockAccount`)이 동작하려면 admin의 `users` 업데이트 권한이 필요하다.
- 보안 규칙 미설정 상태에서는 UI가 막아도 데이터가 취약해질 수 있다.

---

## 8) 자주 실패한 지점과 해결법 (재사용 시 필수)

1. 환경변수 누락
- 증상: Firebase 초기화 실패, 로그인 버튼 무반응/오류
- 해결: `.env.local` 값 점검 후 개발 서버 재시작

2. 프로필 누락 (`PROFILE_NOT_FOUND`)
- 증상: Auth 로그인 성공했는데 앱에서 실패
- 원인: `users/{uid}` 문서 미생성
- 해결: 회원가입 시 `createUserProfile`이 반드시 실행되도록 보장

3. Google 신규 유저 처리 누락
- 증상: Google 로그인 직후 권한/정보 없음
- 해결: 신규 유저는 추가 정보 입력 페이지로 보내고 프로필 완성 후 서비스 진입

4. 잠금 계정 해제 실패
- 증상: 관리자 페이지에서 해제 버튼 오류
- 해결: Firestore Rules에서 admin 업데이트 권한 확인, 대상 문서 존재 확인

5. UI에서만 권한 체크
- 증상: URL 직접 접근/클라이언트 변조에 취약
- 해결: Firestore Rules(필수), 필요 시 Custom Claims까지 적용

---

## 9) 최종 체크리스트
- [ ] Firebase Auth(이메일/Google) 활성화
- [ ] Firestore `users` 프로필 스키마 적용
- [ ] 로그인 실패 누적/잠금 로직 적용
- [ ] `AuthProvider` + `AuthGuard` 적용
- [ ] 관리자 역할(`role=admin`) 생성 절차 문서화
- [ ] `/admin` 페이지에서 잠금 해제 기능 검증
- [ ] Firestore Rules 배포 완료
- [ ] 신규 Google 사용자 프로필 생성 플로우 검증

---

## 10) 이 프로젝트 기준 운영 팁
- 관리자 계정은 최소 2개 이상 운영(비상용 포함).
- 계정 잠금 임계치(`MAX_FAILED_ATTEMPTS=10`)는 서비스 상황에 맞게 조정 가능.
- 장기적으로는 `role`만 신뢰하지 말고 Custom Claims를 함께 사용해 권한 위조 가능성을 줄인다.

